<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charging Station Dashboard</title>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initMap"></script>
    <link rel="stylesheet" href="/static/dashboard.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Left: Charging Station Details -->
        <div class="dashboard-left">
            <h2>Welcome,<br> {{ station.name }} <br>Charging Station</h2>
            <p id="operator-display"><strong>Operator:</strong> {{ station.operator }}</p>
            <p id="charging-type-display"><strong>Charging Type:</strong> {{ station.chargingType }}</p>
            <p id="location-display"><strong>Location:</strong> {{ station.location }}</p>
            <p id="total-slots-display"><strong>Total Slots:</strong> {{ station.total_slots }}</p>
            <p id="charging-rate-display"><strong>Charging Rate:</strong> ₹{{ station.charging_rate }} per kWh</p>

            <div id="slot-warning" style="display: none; color: #ff4444; margin: 10px 0; padding: 10px; background-color: #ffebee; border-radius: 5px;">
                <strong>Warning:</strong> No slots available. New vehicles will be added to the waiting list.
            </div>

            <div id="display-map" style="height: 200px; width: 100%; margin-top: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);"></div>

            <div class="btn-container">
                <button onclick="openModal()" class="btn">Update Information</button>
                <a href="/logout" class="logout-btn" onclick="event.preventDefault(); window.location.href = '/logout';">Logout</a>

            </div>
        </div>

        <!-- Right Side: Vehicle List -->
        <div class="dashboard-right">
            <div class="dashboard-right-header">
                <h2>Current Vehicles</h2>
                <button onclick="openVehicleModal()" class="addbtn">Add Vehicle</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>S.No</th>
                        <th>Slot Number</th>
                        <th>Vehicle Number</th>
                        <th>Estimated Arrival Time</th>
                        <th>Charging Start Time</th>
                        <th>Estimated Departure Time</th>
                        <th>Charging Type</th>
                        <th>Battery Capacity</th>
                        <th>Initial Battery</th>
                        <th>Estimated Charge %</th>
                        <th>Charging Time</th>
                        <th>Wait Time</th>
                        <th>Current Status</th>
                        <th>Cost</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vehicle in vehicles %}
                    <tr id="vehicle-{{ vehicle.id }}">
                        <td>{{ loop.index }}</td>
                        <td>{% if vehicle.slot_number %}{{ vehicle.slot_number }}{% else %}N/A{% endif %}</td>
                        <td>{{ vehicle.vehicle_number }}</td>
                        <td>{{ vehicle.arrival_time }}</td>
                        <td>{% if vehicle.charging_start_time %}{{ vehicle.charging_start_time }}{% else %}N/A{% endif %}</td>
                        <td>{{ vehicle.departure_time }}</td>
                        <td>{{ vehicle.chargingType }}</td>
                        <td>{{ vehicle.battery_capacity }} kWh</td>
                        <td>{{ vehicle.initial_battery_level }}%</td>
                        <td>{% if vehicle.estimated_final_battery is not none %}{{ vehicle.estimated_final_battery }}%{% else %}N/A{% endif %}</td>
                        <td>
                            {% if vehicle.charging_time_minutes >= 60 %}
                                {{ (vehicle.charging_time_minutes / 60) | int }} hrs {{ (vehicle.charging_time_minutes % 60) | int }} min
                            {% else %}
                                {{ vehicle.charging_time_minutes }} min
                            {% endif %}
                        </td>
                        <td>{{ vehicle.wait_time_minutes }} min</td>
                        <td>
                                {% if vehicle.status %}
                                    {{ vehicle.status }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                        <td>₹{{ vehicle.charging_cost }}</td>
                        <td>
                            <button class="remove-btn close-btn" onclick="removeVehicle('{{ vehicle.id }}')">Remove</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
    </div>

    <!-- Booking Result Modal -->
    <div id="bookingResultModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeBookingResultModal()" aria-label="Close Result Modal">&times;</span>
            <h2>Booking Result</h2>
            <div id="booking-result-details"></div>
        </div>
    </div>

<div id="vehicleModal" class="vehiclemodal" role="dialog" aria-labelledby="vehicleModalTitle">
    <div class="vehiclemodal-content">
        <span class="close" onclick="closeVehicleModal()" aria-label="Close Add Vehicle Modal">&times;</span>
        <h2 id="vehicleModalTitle">Add Vehicle</h2>
        
        <form id="addVehicleForm">
            <h3>Vehicle Details</h3>
            <div class="form-group">
                <label for="vehicleNumber">Vehicle Number:</label>
                <div class="input-box">
                    <div class="input-content">
                        <input type="text" id="vehicleNumber" name="vehicle_number" placeholder="Vehicle Number" required>
                        <i class='bx bxs-car'></i>
                    </div>
                    <div class="error-message">Please enter a valid vehicle number</div>
                </div>
                
            </div>

            <div class="form-group">
                <label for="arrivalTime">Arrival Time:</label>
                <input type="time" id="arrivalTime" placeholder="Time of arrival" required>
            </div>

            <h3>Charging Details</h3>
            <div class="form-group">
                <label for="vehicleChargingType">Charging Type:</label>
                <select id="vehicleChargingType" required>
                    <option value="">Select Charging Type</option>
                    <option value="AC Type 1">AC Type 1</option>
                    <option value="AC Type 2">AC Type 2</option>
                    <option value="CCS">CCS</option>
                    <option value="CHAdeMO">CHAdeMO</option>
                    <option value="GB/T">GB/T</option>
                </select>
            </div>

            <h3>Battery Details</h3>
            <div class="form-group">
                <label for="batteryCapacity">Battery Capacity (kWh):</label>
                <input type="number" id="batteryCapacity" value="60" min="1" max="200" required>
            </div>
            <div class="form-group">
                <label for="initialBatteryLevel">Initial Battery Level (%):</label>
                <input type="number" id="initialBatteryLevel" min="0" max="100" required>
            </div>
            <div class="form-group">
                <label for="targetBatteryLevel">Target Battery Level (%):</label>
                <input type="number" id="targetBatteryLevel" min="0" max="100" >
            </div>
            <div class="form-group">
                <label for="chargingTimeMinutes">Charging Time (min): </label>
                <input type="number" id="chargingTimeMinutes" name="charging_time_minutes" min="0" max="1440">
            </div>

            <div class="chargingCost" id="chargingEstimate" style="display: none; margin-top: 15px; ; padding: 10px; background:rgba(0, 0, 0, .2); border-radius: 5px;">
                <h4>Charging Estimates</h4>
                <p>Estimated Time: <span id="estimatedTime">-</span>min</p>
                <p>Estimated Cost: ₹<span id="estimatedCost">-</span></p>
                <p>Estimated Final Battery: <span id="estimatedFinalBattery">-</span>%</p>
            </div>

            <button type="submit" class="save-btn add-vehicle-btn" aria-label="Add Vehicle">Add Vehicle</button>
        </form>
    </div>
</div>


        <div id="Modal" class="modal" role="dialog" aria-labelledby="updateModalTitle">
        <div class="modal-content">
            <span class="close" onclick="closeModal()" aria-label="Close Update Station Modal">&times;</span>
            <h2 id="updateModalTitle">Update Charging Station Details</h2>
            
            <form id="updateForm">
                <label>Station Name:</label>
                <input type="text" id="stationName" value="{{ station.name }}" placeholder="Station name" required>

                <label>Operator Name:</label>
                <input type="text" id="operatorName" value="{{ station.operator }}" placeholder="operator Name" required>

                <label>Charging Type:</label>
                <select id="stationChargingType" required>
                    <option value="">Select Charging Type</option>
                    <option value="AC Type 1" {% if station.chargingType == 'AC Type 1' %}selected{% endif %}>AC Type 1 (₹15/kWh)</option>
                    <option value="AC Type 2" {% if station.chargingType == 'AC Type 2' %}selected{% endif %}>AC Type 2 (₹18/kWh)</option>
                    <option value="CCS" {% if station.chargingType == 'CCS' %}selected{% endif %}>CCS (₹25/kWh)</option>
                    <option value="CHAdeMO" {% if station.chargingType == 'CHAdeMO' %}selected{% endif %}>CHAdeMO (₹25/kWh)</option>
                    <option value="GB/T" {% if station.chargingType == 'GB/T' %}selected{% endif %}>GB/T (₹20/kWh)</option>
                </select>

                <label>Location:</label>
                <input type="text" id="location" value="{{ station.location }}" placeholder="Location" required>

                <label>Total Slots:</label>
                <input type="number" id="totalSlots" min="1" value="{{ station.total_slots }}" placeholder="Number of slots" required>


                <label>Charging Rate (₹/kWh):</label>
                <input type="number" id="chargingRate" min="1" value="{{ station.charging_rate }}" placeholder="Charging rate" required>

                <label>Location on Map:</label>
                <input id="map-search" type="text" placeholder="Search for location..." style="width:100%;margin-bottom:10px;padding:8px;border-radius:4px;border:1px solid #ccc;">
                <div id="modal-map" style="height: 300px; width: 100%; margin-bottom: 20px; border-radius: 5px;"></div>
                <input type="hidden" id="latitude" name="latitude" value="{{ station.latitude if station.latitude else '' }}">
                <input type="hidden" id="longitude" name="longitude" value="{{ station.longitude if station.longitude else '' }}">

                <div class="button-group">
                    <button type="button" class="close-btn" onclick="closeModal()" aria-label="Close">Close</button>
                    <button type="submit" class="save-btn" aria-label="Save Changes">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

<script>
    // Track form changes
    let formChanged = false;
    const form = document.getElementById("updateForm");
    let initialFormData = new FormData(form);

    // Add event listeners to all form inputs to track changes
    form.querySelectorAll('input').forEach(input => {
        input.addEventListener('change', () => {
            formChanged = true;
        });
    });

    // Function to update charging rate based on charging type
    function updateChargingRate(selectElement) {
        const chargingRates = {
            'AC Type 1': 15,
            'AC Type 2': 18,
            'CCS': 25,
            'CHAdeMO': 25,
            'GB/T': 20,
        };
        
        const selectedType = selectElement.value;
        const chargingRateInput = document.getElementById('chargingRate');
        if (selectedType && chargingRates[selectedType]) {
            chargingRateInput.value = chargingRates[selectedType];
            formChanged = true;
        } else {
            chargingRateInput.value = ''; // Clear if no type selected or type not found
        }
    }

    // Add event listener for charging type changes
    document.getElementById('stationChargingType').addEventListener('change', function() {
        updateChargingRate(this);
    });

    // Initial call to set rate if a type is already selected (e.g., on page load from existing data)
    document.addEventListener('DOMContentLoaded', function() {
        const stationChargingTypeSelect = document.getElementById('stationChargingType');
        updateChargingRate(stationChargingTypeSelect);
    });

    // Function to check for unsaved changes
    function hasUnsavedChanges() {
        if (!formChanged) return false;
        
        const currentFormData = new FormData(form);
        for (let [key, value] of currentFormData.entries()) {
            if (initialFormData.get(key) !== value) {
                return true;
            }
        }
        return false;
    }

    // Modified closeModal function with confirmation
    function closeModal() {
        if (hasUnsavedChanges()) {
            if (confirm("You have unsaved changes. Are you sure you want to close without saving?")) {
                document.getElementById("Modal").style.display = "none";
                formChanged = false;
            }
        } else {
            document.getElementById("Modal").style.display = "none";
        }
    }

    // Reset form change tracking when modal is opened
    function openModal() {
        document.getElementById("Modal").style.display = "flex";
        formChanged = false;
        // Update initial form data
        initialFormData = new FormData(form);
        trapFocus(document.getElementById("Modal"));
    }

    // Target the save button specifically within the update form
    document.querySelector("#updateForm .save-btn").addEventListener("click", async function(event) {
        event.preventDefault();
        formChanged = false;

        const submitBtn = this;
        toggleLoadingState(submitBtn, true);

        // Get all input elements
        const stationNameInput = document.getElementById("stationName");
        const operatorNameInput = document.getElementById("operatorName");
        const chargingTypeInput = document.getElementById("stationChargingType");
        const locationInput = document.getElementById("location");
        const totalSlotsInput = document.getElementById("totalSlots");
        const chargingRateInput = document.getElementById("chargingRate");
        const latitudeInput = document.getElementById("latitude");
        const longitudeInput = document.getElementById("longitude");

        // Remove previous errors
        document.querySelectorAll('#updateForm .error-message').forEach(el => el.remove());
        [stationNameInput, operatorNameInput, chargingTypeInput, locationInput, totalSlotsInput, chargingRateInput].forEach(input => input.classList.remove('invalid-input'));

        // Helper for error display
        function displayError(input, message) {
    input.classList.add('invalid-input');
    // Remove any previous error for this field
    let next = input.nextElementSibling;
    if (next && next.classList.contains('error-message')) {
        next.remove();
    }
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.textContent = message;
    // Insert error after input/select
    if (input.nextElementSibling) {
        input.parentNode.insertBefore(errorDiv, input.nextElementSibling);
    } else {
        input.parentNode.appendChild(errorDiv);
    }
}

        // Validate fields
        let isValid = true;
        if (!stationNameInput.value.trim()) {
            displayError(stationNameInput, "Station name is required.");
            isValid = false;
        }
        if (!operatorNameInput.value.trim()) {
            displayError(operatorNameInput, "Operator name is required.");
            isValid = false;
        }
        if (!chargingTypeInput.value.trim()) {
            displayError(chargingTypeInput, "Charging type is required.");
            isValid = false;
        }
        if (!locationInput.value.trim()) {
            displayError(locationInput, "Location is required.");
            isValid = false;
        }
        if (!totalSlotsInput.value.trim() || isNaN(totalSlotsInput.value) || Number(totalSlotsInput.value) < 1) {
            displayError(totalSlotsInput, "Total slots must be at least 1.");
            isValid = false;
        }
        if (!chargingRateInput.value.trim() || isNaN(chargingRateInput.value) || Number(chargingRateInput.value) < 1) {
            displayError(chargingRateInput, "Charging rate must be at least 1.");
            isValid = false;
        }
        // Latitude/longitude are hidden, can add validation if needed

        if (!isValid) {
            toggleLoadingState(submitBtn, false);
            return;
        }

        let stationName = stationNameInput.value;
        let operatorName = operatorNameInput.value;
        let chargingType = chargingTypeInput.value;
        let location = locationInput.value;
        let totalSlots = totalSlotsInput.value;
        let chargingRate = chargingRateInput.value;
        let latitude = latitudeInput.value;
        let longitude = longitudeInput.value;

        const requestData = {
            stationName: stationName,
            operatorName: operatorName,
            chargingType: chargingType,
            location: location,
            totalSlots: totalSlots,
            chargingRate: chargingRate,
            latitude: latitude,
            longitude: longitude
        };

        console.log("Sending station update data:", requestData);  // Debug log

        try {
            const response = await fetch("/update_station", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(requestData)
            });

            console.log("Raw response:", response);
            if (!response.ok) {
                const text = await response.text();
                throw new Error(text);
            }
            const data = await response.json();

            console.log("Parsed data:", data);
            if (data.message) {
                // Update the displayed values directly
                document.querySelector(".dashboard-left h2").innerHTML = `Welcome,<br> ${stationName} <br>Charging Station`;
                document.getElementById("operator-display").innerHTML = `<strong>Operator:</strong> ${operatorName}`;
                document.getElementById("charging-type-display").innerHTML = `<strong>Charging Type:</strong> ${chargingType}`;
                document.getElementById("location-display").innerHTML = `<strong>Location:</strong> ${location}`;
                document.getElementById("total-slots-display").innerHTML = `<strong>Total Slots:</strong> ${totalSlots}`;
                document.getElementById("charging-rate-display").innerHTML = `<strong>Charging Rate:</strong> ₹${chargingRate} per kWh`;

                // Close the modal
                document.getElementById("Modal").style.display = "none";
                
                // Show success message
                const successMessage = document.createElement('div');
                successMessage.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background-color: #4CAF50;
                    color: white;
                    padding: 15px 25px;
                    border-radius: 5px;
                    z-index: 1000;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                `;
                successMessage.textContent = "Changes saved successfully!";
                document.body.appendChild(successMessage);

                setTimeout(() => {
                    successMessage.remove();
                }, 3000);

                // Re-initialize the display map to reflect updated coordinates
                if (typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
                    if (window.initMap) window.initMap();
                } else {
                    console.warn("Google Maps API not loaded, cannot re-initialize display map.");
                }

            } else {
                alert(data.error);
            }
        } catch (error) {
            console.error("Update Error:", error);
            alert("An error occurred while updating. Please try again." + error.message);
        } finally {
            toggleLoadingState(submitBtn, false); // Hide loading state
        }
    });

    // Close modal when clicking outside
    window.onclick = function(event) {
        let updateModal = document.getElementById("Modal");
        let vehicleModal = document.getElementById("vehicleModal");

        if (event.target === updateModal) {
            closeModal();
        }
        if (event.target === vehicleModal) {
            closeVehicleModal();
        }
    };

    // Open the Add Vehicle Modal
    function openVehicleModal() {
        document.getElementById('vehicleModal').style.display = 'flex';
        document.getElementById('vehicleModalTitle').textContent = 'Add Vehicle';
        document.getElementById('vehicleId').value = '';
        const form = document.getElementById('addVehicleForm');
        form.reset();
        form.setAttribute('data-edit-mode', 'false');
        
        // Reset charging inputs and estimates
        resetChargingInputs();
        
        // Focus the first input field for better UX
        const firstInput = form.querySelector('input:not([type="hidden"])');
        if (firstInput) {
            setTimeout(() => firstInput.focus(), 100);
        }
        
        trapFocus(document.getElementById('vehicleModal'));
    }

    // Close the Add Vehicle Modal
    function closeVehicleModal() {
        document.getElementById("vehicleModal").style.display = "none";
    }

    // Add this function to dynamically refresh the vehicle table
    async function refreshVehicleTable() {
        try {
            // Fetch the latest vehicles data from the dashboard endpoint
            const response = await fetch("/dashboard"); // Assuming this endpoint returns the full dashboard HTML, or we can make a dedicated /api/vehicles endpoint
            const html = await response.text();

            // Create a temporary DOM element to parse the HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // Find the table body from the parsed HTML
            const newTableBody = doc.querySelector(".dashboard-right table tbody");
            const currentTableBody = document.querySelector(".dashboard-right table tbody");

            if (newTableBody && currentTableBody) {
                // Replace the old table body with the new one
                currentTableBody.innerHTML = newTableBody.innerHTML;
            } else {
                console.error("Could not find table body elements for refresh.");
            }


            // Update slot warning
            const slotWarning = document.getElementById("slot-warning");
            const newSlotWarning = doc.getElementById("slot-warning");
            if (slotWarning && newSlotWarning) {
                slotWarning.style.display = newSlotWarning.style.display;
                slotWarning.innerHTML = newSlotWarning.innerHTML; // To get updated text if any
            }


            console.log("Vehicle table refreshed successfully.");

        } catch (error) {
            console.error("Error refreshing vehicle table:", error);
            alert("Failed to refresh vehicle list. Please refresh the page manually.");
        }
    }

    document.getElementById("addVehicleForm").addEventListener("submit", async function(event) {
        event.preventDefault();

        const addVehicleBtn = this.querySelector('.add-vehicle-btn');
        toggleLoadingState(addVehicleBtn, true);

        // Get all input elements
        const vehicleNumberInput = document.getElementById("vehicleNumber");
        const initialBatteryLevelInput = document.getElementById("initialBatteryLevel");
        const targetBatteryLevelInput = document.getElementById("targetBatteryLevel");
        const chargingTimeMinutesInput = document.getElementById("chargingTimeMinutes");
        const arrivalTimeInput = document.getElementById("arrivalTime");
        const vehicleChargingTypeInput = document.getElementById("vehicleChargingType");
        const batteryCapacityInput = document.getElementById("batteryCapacity");

        // Check for missing inputs
        const allInputs = [vehicleNumberInput, initialBatteryLevelInput, targetBatteryLevelInput, chargingTimeMinutesInput, arrivalTimeInput, vehicleChargingTypeInput, batteryCapacityInput];
        if (allInputs.some(input => input === null)) {
            alert("A required form input is missing from the page. Please reload or contact support.");
            toggleLoadingState(addVehicleBtn, false);
            return;
        }

        // Helper to show error
        function displayError(input, message) {
            input.classList.add('invalid-input');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            input.parentNode.appendChild(errorDiv);
        }

        // Clear previous error messages and styles
        document.querySelectorAll('.error-message').forEach(el => el.remove());
        [vehicleNumberInput, initialBatteryLevelInput, targetBatteryLevelInput, chargingTimeMinutesInput, arrivalTimeInput, vehicleChargingTypeInput, batteryCapacityInput].forEach(input => {
            if (input) input.classList.remove('invalid-input');
        });

        // Get values
        const vehicleNumber = vehicleNumberInput.value.trim();
        const vehicleNumberRegex = /^[A-Z]{2}\d{2}[A-Z]{1,2}\d{4}$/;
        const arrivalTime = arrivalTimeInput.value;
        const initialBatteryLevel = initialBatteryLevelInput.value;
        const targetBatteryLevel = targetBatteryLevelInput.value;
        const chargingTimeMinutes = chargingTimeMinutesInput.value;
        const chargingType = vehicleChargingTypeInput.value;
        const batteryCapacity = batteryCapacityInput.value;

        let isValid = true;

        // Vehicle number validation
        if (!vehicleNumber) {
            displayError(vehicleNumberInput, "Vehicle number is required.");
            isValid = false;
        } else if (!vehicleNumberRegex.test(vehicleNumber)) {
            displayError(vehicleNumberInput, "Invalid vehicle number format (e.g., MH12AB1234)");
            isValid = false;
        }

        // Arrival time validation
        if (!arrivalTime) {
            displayError(arrivalTimeInput, "Arrival time is required.");
            isValid = false;
        }

        // At least one of targetBatteryLevel or chargingTimeMinutes must be provided
        // Require at least one of the two fields
        if ((targetBatteryLevel === '' || isNaN(Number(targetBatteryLevel))) && (chargingTimeMinutes === '' || isNaN(Number(chargingTimeMinutes)))) {
            displayError(targetBatteryLevelInput, "Enter either target battery level or charging time.");
            displayError(chargingTimeMinutesInput, "Enter either charging time or target battery level.");
            isValid = false;
        }

        // Only validate targetBatteryLevel if provided
        if (targetBatteryLevel !== '' && !isNaN(Number(targetBatteryLevel))) {
            if (Number(targetBatteryLevel) < 0 || Number(targetBatteryLevel) > 100) {
                displayError(targetBatteryLevelInput, "Please enter a valid target battery level (0-100%).");
                isValid = false;
            }
        }
        // Only validate chargingTimeMinutes if provided
        if (chargingTimeMinutes !== '' && !isNaN(Number(chargingTimeMinutes))) {
            if (Number(chargingTimeMinutes) <= 0) {
                displayError(chargingTimeMinutesInput, "Charging time must be greater than 0 minutes.");
                isValid = false;
            }
        }

        if (!chargingType) {
            displayError(vehicleChargingTypeInput, "Charging type is required.");
            isValid = false;
        }

        if (isNaN(initialBatteryLevel) || initialBatteryLevel < 0 || initialBatteryLevel > 100) {
            displayError(initialBatteryLevelInput, "Please enter a valid initial battery level (0-100%).");
            isValid = false;
        }

        // Only validate targetBatteryLevel if it is provided (not empty)
        if (targetBatteryLevel !== '' && !isNaN(Number(targetBatteryLevel))) {
            if (Number(targetBatteryLevel) < 0 || Number(targetBatteryLevel) > 100) {
                displayError(targetBatteryLevelInput, "Please enter a valid target battery level (0-100%).");
                isValid = false;
            }
        }

        // Only validate if targetBatteryLevel is filled and valid
        if (targetBatteryLevel !== '' && !isNaN(Number(targetBatteryLevel))) {
            if (Number(targetBatteryLevel) <= Number(initialBatteryLevel)) {
                displayError(targetBatteryLevelInput, "Target battery level must be greater than initial battery level.");
                isValid = false;
            }
        }

        if (isNaN(batteryCapacity) || batteryCapacity <= 0) {
            displayError(batteryCapacityInput, "Please enter a valid battery capacity (e.g., 60 kWh).");
            isValid = false;
        }

        if (!isValid) {
            toggleLoadingState(addVehicleBtn, false); // Hide loading state if validation fails
            return; // Stop form submission if validation fails
        }

        const requestData = {
            vehicleNumber: vehicleNumber,
            arrivalTime: arrivalTime,
            chargingType: chargingType,
            initialBatteryLevel: initialBatteryLevel,
            targetBatteryLevel: targetBatteryLevel,
            charging_time_minutes: chargingTimeMinutes,
            batteryCapacity: batteryCapacity
        };

        try {
            const response = await fetch("/add_vehicle", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(requestData)
            });
            const data = await response.json();

            if (data.message) {
                closeVehicleModal(); // Close modal
                
                // Refresh the entire table after a successful add
                await refreshVehicleTable();

                // Show success message
                const successMessage = document.createElement('div');
                successMessage.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background-color: #4CAF50;
                    color: white;
                    padding: 15px 25px;
                    border-radius: 5px;
                    z-index: 1000;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                `;
                successMessage.textContent = "Vehicle added successfully!";
                document.body.appendChild(successMessage);

                setTimeout(() => {
                    successMessage.remove();
                }, 3000);

                // Clear the form
                document.getElementById("addVehicleForm").reset();
                // If charging_time_minutes was provided and estimated_final_battery is in the response, show it
                if (requestData.charging_time_minutes && data.estimated_final_battery !== undefined && data.estimated_final_battery !== null) {
                    document.getElementById('estimatedFinalBattery').textContent = data.estimated_final_battery;
                    document.getElementById('chargingEstimate').style.display = 'block';
                } else {
                    document.getElementById('chargingEstimate').style.display = 'none';
                }
            } else {
                alert(data.error);
            }
        } catch (error) {
            console.error("Error:", error);
            alert("An error occurred while adding the vehicle. Please try again.");
        } finally {
            toggleLoadingState(addVehicleBtn, false); // Hide loading state
        }
    });

    // Update removeVehicle function to handle slot updates and refresh table
    async function removeVehicle(vehicleId) {
        // Show confirmation dialog before proceeding
        if (!window.confirm('Are you sure you want to remove this vehicle?')) {
            return;
        }
        try {
            const response = await fetch("/remove_vehicle", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ vehicle_id: vehicleId })
            });
            const data = await response.json();

            if (data.message) {
                // Refresh the entire table after a successful remove
                await refreshVehicleTable();

                // Show success message
                const successMessage = document.createElement('div');
                successMessage.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background-color: #4CAF50;
                    color: white;
                    padding: 15px 25px;
                    border-radius: 5px;
                    z-index: 1000;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                `;
                successMessage.textContent = "Vehicle removed successfully!";
                document.body.appendChild(successMessage);

                setTimeout(() => {
                    successMessage.remove();
                }, 3000);
            }
        } catch (error) {
            console.error("Error:", error);
            alert("An error occurred while removing the vehicle. Please try again.");
        }
    }

    // This part ensures that if you navigate away with unsaved changes, you get a warning
    window.onbeforeunload = function() {
        if (formChanged) {
            return "You have unsaved changes. Do you want to leave without saving?";
        }
    };

    // Ensure the update modal is hidden when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById("Modal").style.display = "none";
        refreshVehicleTable(); // Initial load of the table after DOM is ready
    });


    // Add this to your existing JavaScript
    function updateChargingEstimate() {
        // Declare all variables only once
        const batteryCapacity = parseFloat(document.getElementById('batteryCapacity').value);
        const initialLevel = parseFloat(document.getElementById('initialBatteryLevel').value);
        const targetLevel = parseFloat(document.getElementById('targetBatteryLevel').value);
        const chargingType = document.getElementById('vehicleChargingType').value;
        const chargingTimeInput = document.getElementById('chargingTimeMinutes');
        const chargingTime = parseFloat(chargingTimeInput.value);

        // Charging rates (₹ per kWh) by type
        const chargingRates = {
            'AC Type 1': 15,
            'AC Type 2': 18,
            'CCS': 25,
            'CHAdeMO': 25,
            'GB/T': 20,
        };
        // Charger powers (kW) by type
        const chargingSpeeds = {
            'AC Type 1': 7.4,
            'AC Type 2': 22.0,
            'CCS': 150.0,
            'CHAdeMO': 62.5,
            'GB/T': 120.0,
        };
        // Charging efficiency by type
        const chargingEfficiency = {
            'AC Type 1': 0.85,
            'AC Type 2': 0.88,
            'CCS': 0.92,
            'CHAdeMO': 0.92,
            'GB/T': 0.90,
        };

        // Calculate cost and time estimates using unified backend-consistent logic
        // Only use charging time mode if user entered a value and targetLevel is blank or NaN
        if (!isNaN(chargingTime) && chargingTime > 0 && (isNaN(targetLevel) || targetLevel === "") && chargingType && !isNaN(batteryCapacity) && !isNaN(initialLevel)) {
            // Charging time input mode
            const chargerPower = chargingSpeeds[chargingType] || 7.4;
            const efficiency = chargingEfficiency[chargingType] || 0.85;
            const chargingRate = chargingRates[chargingType] || 15;
            const hours = chargingTime / 60.0;
            const energyAdded = chargerPower * hours * efficiency;
            const maxEnergyAddable = ((100 - initialLevel) / 100) * batteryCapacity;
            const usableEnergy = Math.min(energyAdded, maxEnergyAddable);
            const finalBattery = Math.min(initialLevel + (usableEnergy / batteryCapacity) * 100, 100);
            const chargingCost = (usableEnergy / efficiency) * chargingRate;
            document.getElementById('estimatedTime').textContent = Math.round(chargingTime);
            document.getElementById('estimatedCost').textContent = Math.round(chargingCost);
            // Round to nearest whole number
            document.getElementById('estimatedFinalBattery').textContent = Math.round(finalBattery);
            document.getElementById('chargingEstimate').style.display = 'block';
        // Only use target battery mode if user entered a value and chargingTime is blank or NaN
        } else if (!isNaN(targetLevel) && targetLevel > initialLevel && targetLevel <= 100 && (isNaN(chargingTime) || chargingTime === "") && chargingType && !isNaN(batteryCapacity) && !isNaN(initialLevel)) {
            // Target battery input mode
            const chargerPower = chargingSpeeds[chargingType] || 7.4;
            const efficiency = chargingEfficiency[chargingType] || 0.85;
            const chargingRate = chargingRates[chargingType] || 15;
            const energyNeeded = ((targetLevel - initialLevel) / 100) * batteryCapacity;
            const chargingTimeHours = energyNeeded / (chargerPower * efficiency);
            const chargingTimeMinutes = chargingTimeHours * 60;
            const chargingCost = (energyNeeded / efficiency) * chargingRate;
            document.getElementById('estimatedTime').textContent = Math.round(chargingTimeMinutes);
            document.getElementById('estimatedCost').textContent = Math.round(chargingCost);
            document.getElementById('estimatedFinalBattery').textContent = Math.round(targetLevel * 10) / 10;
            document.getElementById('chargingEstimate').style.display = 'block';
        } else {
            document.getElementById('estimatedCost').textContent = '-';
            document.getElementById('chargingEstimate').style.display = 'none';
        }
    }

    // Add event listeners for real-time updates
    document.getElementById('batteryCapacity').addEventListener('input', updateChargingEstimate);
    document.getElementById('initialBatteryLevel').addEventListener('input', updateChargingEstimate);
    document.getElementById('targetBatteryLevel').addEventListener('input', updateChargingEstimate);
    document.getElementById('vehicleChargingType').addEventListener('change', updateChargingEstimate);
    document.getElementById('chargingTimeMinutes').addEventListener('input', updateChargingEstimate);

    // Reset charging inputs when modal is opened
    function resetChargingInputs() {
        const targetInput = document.getElementById('targetBatteryLevel');
        const timeInput = document.getElementById('chargingTimeMinutes');
        targetInput.disabled = false;
        timeInput.disabled = false;
        targetInput.value = '';
        timeInput.value = '';
        document.getElementById('chargingEstimate').style.display = 'none';
    }

    // Disable one input if the other is filled
    function syncChargingInputs() {
        const targetInput = document.getElementById('targetBatteryLevel');
        const timeInput = document.getElementById('chargingTimeMinutes');
        
        // Reset both inputs first
        targetInput.disabled = false;
        timeInput.disabled = false;
        
        // Then apply the appropriate disabled state
        if (targetInput.value && targetInput.value.trim() !== '' && !isNaN(Number(targetInput.value))) {
            timeInput.disabled = true;
        } else if (timeInput.value && timeInput.value.trim() !== '' && !isNaN(Number(timeInput.value))) {
            targetInput.disabled = true;
        }
    }
    
    document.getElementById('targetBatteryLevel').addEventListener('input', syncChargingInputs);
    document.getElementById('chargingTimeMinutes').addEventListener('input', syncChargingInputs);
    
    // Add reset when modal is opened
    document.getElementById('addVehicleForm').addEventListener('reset', resetChargingInputs);
    
    // Run once on load
    syncChargingInputs();
    

    // Function to sort the vehicle table by charging start time
    function sortVehicleTableByChargingStartTime() {
        const tableBody = document.querySelector(".dashboard-right table tbody");
        const rows = Array.from(tableBody.querySelectorAll("tr"));

        rows.sort((a, b) => {

            const timeA = a.cells[4].textContent.trim();
            const timeB = b.cells[4].textContent.trim();

            // Handle "N/A" values by treating them as very large numbers (will be sorted to the end)
            if (timeA === "N/A") return 1;
            if (timeB === "N/A") return -1;

            // Convert to minutes since midnight for comparison
            const [hA, mA] = timeA.split(":").map(Number);
            const [hB, mB] = timeB.split(":").map(Number);
            const minutesA = hA * 60 + mA;
            const minutesB = hB * 60 + mB;

            return minutesA - minutesB;
        });

        // Re-append sorted rows and update index column
        rows.forEach((row, idx) => {
            row.cells[0].textContent = idx + 1;
            tableBody.appendChild(row);
        });
    }

    // Helper function to show/hide loading spinner and disable/enable button
    function toggleLoadingState(button, isLoading) {
        console.log(`toggleLoadingState called for button: ${button.id || button.className}, isLoading: ${isLoading}`);
        if (isLoading) {
            button.classList.add('loading');
            button.setAttribute('disabled', 'true');
            const spinnerSpan = document.createElement('span');
            spinnerSpan.className = 'spinner';
            button.appendChild(spinnerSpan);
        } else {
            button.classList.remove('loading');
            button.removeAttribute('disabled');
            const spinner = button.querySelector('.spinner');
            if (spinner) {
                spinner.remove();
            }
        }
    }

    function trapFocus(modal) {
        const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea');
        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];

        modal.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                if (e.shiftKey) { // Shift + Tab
                    if (document.activeElement === firstElement || document.activeElement === modal) {
                        e.preventDefault();
                        lastElement.focus();
                    }
                } else { // Tab
                    if (document.activeElement === lastElement) {
                        e.preventDefault();
                        firstElement.focus();
                    }
                }
            } else if (e.key === 'Escape') {
                // Optionally close modal on Escape key
                if (modal.id === 'vehicleModal') {
                    closeVehicleModal();
                } else if (modal.id === 'Modal') {
                    closeModal();
                }
            }
        });
    }

    document.getElementById("Modal").addEventListener('transitionend', function() {
        if (this.style.display === 'flex') {
            trapFocus(this);
            // Optionally focus the first focusable element when modal opens
            const firstFocusable = this.querySelector('button, [href], input, select, textarea');
            if (firstFocusable) {
                firstFocusable.focus();
            }
        }
    });

    document.getElementById("vehicleModal").addEventListener('transitionend', function() {
        if (this.style.display === 'flex') {
            trapFocus(this);
            // Optionally focus the first focusable element when modal opens
            const firstFocusable = this.querySelector('button, [href], input, select, textarea');
            if (firstFocusable) {
                firstFocusable.focus();
            }
        }
    });

</script>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="/static/chngs.js"></script>
<script>


// --- Booking Result Modal ---
function showBookingResult(result) {
    let html = '';
    if (result.status === 'confirmed') {
        html += `<p><strong>Booking Confirmed!</strong></p>`;
        html += `<p>Assigned Slot: <strong>${result.assigned_slot}</strong></p>`;
        html += `<p>Scheduled Start: <strong>${result.scheduled_start_time}</strong></p>`;
        html += `<p>Scheduled End: <strong>${result.scheduled_end_time}</strong></p>`;
        html += `<p>Wait Time: <strong>${result.wait_time_minutes}</strong> min</p>`;
        html += `<p>Priority Score: <strong>${result.priority_score}</strong></p>`;
    } else {
        html += `<p style="color:red"><strong>Booking Failed:</strong> ${result.message || 'Unknown error.'}</p>`;
    }
    document.getElementById('booking-result-details').innerHTML = html;
    document.getElementById('bookingResultModal').style.display = 'flex';
}
function closeBookingResultModal() {
    document.getElementById('bookingResultModal').style.display = 'none';
}

// --- Example: Hook to booking form (replace with your actual booking form logic) ---
// document.getElementById('yourBookingForm').onsubmit = function(e) {
//     e.preventDefault();
//     // Collect form data...
//     axios.post('/create_booking', bookingData)
//         .then(res => showBookingResult(res.data))
//         .catch(err => showBookingResult({status: 'error', message: err.response?.data?.message || 'Booking failed.'}));
// };

// On page load, fetch queue (replace '{{ station.id }}' with actual station id variable)
document.addEventListener('DOMContentLoaded', function() {
    fetchAndRenderStationQueue('{{ station.id }}');
});
</script>
<script>
    function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}
    // Get the initial number of vehicles displayed on the page
    const initialVehicleCount = document.querySelectorAll("#vehicle-table tbody tr").length;
    let previousData=0;
    // This function will run on a schedule
    async function checkForUpdates() {
        try {
            // Ask our new API for the latest vehicle count
            const response = await fetch('/api/vehicle_count');
            const data = await response.json();
            if (data.vehicle_count !== undefined  ) {
                // If the count on the server is different from what's on the page...
                console.log('Change detected! Refreshing page...');
                location.reload(); // ...refresh the page!
            } else {
                console.log('No changes detected.');
            }
            previousData=data.vehicle_count;
        } catch (error) {
            console.error('Error checking for updates:', error);
        }
    }

    // Run the checkForUpdates function every 20 seconds
    setInterval(checkForUpdates, 20000*3*2); 
</script>
</body>
</html>
